name: Terraform Bootstrap (One-Time Setup)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to bootstrap (dev or prod)'
        required: true
        type: choice
        options:
          - dev
          - prod
      confirm:
        description: 'Type "BOOTSTRAP" to confirm (this creates infrastructure)'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  bootstrap:
    name: Bootstrap ${{ inputs.environment }} Environment
    runs-on: ubuntu-latest

    environment: ${{ inputs.environment }}

    env:
      AWS_REGION: us-east-1
      TF_VERSION: "1.10.0"
      ENVIRONMENT: ${{ inputs.environment }}

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "BOOTSTRAP" ]; then
            echo "âŒ Confirmation failed. You must type 'BOOTSTRAP' to proceed."
            exit 1
          fi
          echo "âœ… Confirmation validated"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Display bootstrap info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Terraform Bootstrap - ONE TIME SETUP"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo ""
          echo "This will:"
          echo "  1. Create S3 bucket for Terraform state"
          echo "  2. Create DynamoDB table for state locking"
          echo "  3. Initialize Terraform backend"
          echo "  4. Create all infrastructure resources"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check if backend already exists
        id: check-backend
        run: |
          BUCKET_NAME="artguard-terraform-state"

          # Check if S3 bucket exists
          if aws s3 ls "s3://$BUCKET_NAME" 2>/dev/null; then
            echo "bucket_exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ S3 bucket already exists: $BUCKET_NAME"
          else
            echo "bucket_exists=false" >> $GITHUB_OUTPUT
            echo "âœ… S3 bucket does not exist yet"
          fi

          # Check if state file exists for this environment
          STATE_KEY="${{ env.ENVIRONMENT }}/terraform.tfstate"
          if aws s3 ls "s3://$BUCKET_NAME/$STATE_KEY" 2>/dev/null; then
            echo "state_exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ State file already exists: $STATE_KEY"
          else
            echo "state_exists=false" >> $GITHUB_OUTPUT
            echo "âœ… State file does not exist yet"
          fi

      - name: Setup backend (S3 + DynamoDB)
        run: |
          cd infra/terraform
          chmod +x setup-backend.sh

          echo "Running setup-backend.sh..."
          ./setup-backend.sh

          echo "âœ… Backend setup complete!"

      - name: Terraform Init
        working-directory: infra/terraform
        run: |
          echo "ğŸ”§ Initializing Terraform..."

          if [ "${{ steps.check-backend.outputs.state_exists }}" == "true" ]; then
            # State already exists, just initialize
            echo "âš ï¸ State file exists, initializing without migration..."
            terraform init -backend-config=backend-${{ env.ENVIRONMENT }}.hcl
          else
            # First time setup, initialize backend
            echo "âœ… First time setup, initializing backend..."
            terraform init -backend-config=backend-${{ env.ENVIRONMENT }}.hcl
          fi

      - name: Terraform Validate
        working-directory: infra/terraform
        run: |
          echo "âœ… Validating Terraform configuration..."
          terraform validate

      - name: Terraform Plan
        working-directory: infra/terraform
        run: |
          echo "Creating Terraform plan for ${{ env.ENVIRONMENT }}..."
          terraform plan -var-file=${{ env.ENVIRONMENT }}.tfvars -out=tfplan

          echo ""
          echo "âš ï¸ IMPORTANT: Review the plan above before proceeding"
          echo ""

      - name: Terraform Apply
        working-directory: infra/terraform
        run: |
          echo "Applying Terraform configuration..."
          terraform apply -auto-approve tfplan

          echo "âœ… Infrastructure created!"

      - name: Save Terraform Outputs
        working-directory: infra/terraform
        run: |
          echo "Saving Terraform outputs..."
          terraform output -json > outputs.json

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Bootstrap Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Frontend URL:"
          terraform output -raw cloudfront_distribution_url || echo "Not available"
          echo ""
          echo "Backend API:"
          terraform output -raw apprunner_service_url || echo "Not available"
          echo ""
          echo "S3 Frontend Bucket:"
          terraform output -raw s3_frontend_bucket_name || echo "Not available"
          echo ""
          echo "CloudFront Distribution ID:"
          terraform output -raw cloudfront_distribution_id || echo "Not available"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo " Your ${{ env.ENVIRONMENT }} environment is ready!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Upload outputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ env.ENVIRONMENT }}
          path: infra/terraform/outputs.json
          retention-days: 30
